name: Security Audit

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run security audit daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  security-audit:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        
    - name: Setup pnpm
      uses: pnpm/action-setup@v4
      with:
        version: 8
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Run security audit
      run: |
        echo "Running pnpm audit..."
        pnpm audit --audit-level moderate || true
        
    - name: Run npm audit (alternative check)
      run: |
        echo "Running npm audit as backup check..."
        npm audit --audit-level moderate || true
        
    - name: Check for high/critical vulnerabilities
      run: |
        echo "Checking for high/critical vulnerabilities..."
        AUDIT_RESULT=$(pnpm audit --audit-level high --json 2>/dev/null || echo '{"vulnerabilities":{}}')
        HIGH_VULNS=$(echo "$AUDIT_RESULT" | jq '.vulnerabilities | length' 2>/dev/null || echo "0")
        
        if [ "$HIGH_VULNS" -gt 0 ]; then
          echo "❌ Found $HIGH_VULNS high/critical vulnerabilities!"
          pnpm audit --audit-level high
          exit 1
        else
          echo "✅ No high/critical vulnerabilities found"
        fi
        
    - name: Generate security report
      if: always()
      run: |
        echo "# Security Audit Report" > security-report.md
        echo "Generated on: $(date)" >> security-report.md
        echo "" >> security-report.md
        echo "## Audit Results" >> security-report.md
        pnpm audit --json 2>/dev/null | jq -r '
          if .vulnerabilities then
            "Total vulnerabilities: " + (.vulnerabilities | length | tostring) + "\n" +
            (.vulnerabilities | to_entries[] | 
              "- " + .key + ": " + .value.severity + " severity")
          else
            "No vulnerabilities found"
          end
        ' >> security-report.md 2>/dev/null || echo "No vulnerabilities found" >> security-report.md
        
    - name: Upload security report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: security-audit-report
        path: security-report.md
        retention-days: 30

  dependency-review:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Dependency Review
      uses: actions/dependency-review-action@v4
      with:
        fail-on-severity: high
        allow-licenses: MIT, Apache-2.0, BSD-2-Clause, BSD-3-Clause, ISC, GPL-3.0-or-later, LGPL-2.1
